{% extends "base.html" %}

{% load widget_tweaks %}

{% load static %}

{% block title %} Relatório de Liberação dos Valores {% endblock title %}

{% block content %}

{% include "../stylemsg.html" %}

    <div style="color:#4682B4; font-style: bold; font-size: 1.5rem; border-bottom: 1px solid white;">
        Relatório de Liberação dos Valores
    </div>
    <hr>
    <p>Este relatório irá emitir a relação dos clientes e respectivos valores liberados referentes aos processos que
        estejam com status de "Finalizado" com base nos filtros selecionados.</p>
    <br>
    <p><b>Seleção e filtros</b></p>
    <form enctype="multipart/form-data" method="post" id="relatorioForm">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-md-2.5">
                <label for="{{ form.liberacao_ini.id_for_label }}">Data Liberação (Inicial):</label>
                {{ form.liberacao_ini }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-2.5">
                <label for="{{ form.liberacao_fin.id_for_label }}">Data Liberação (Final):</label>
                {{ form.liberacao_fin }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="{{ form.linhacredito.id_for_label }}">Linha de Crédito:</label>
                {{ form.linhacredito }}
            </div>
        </div>
        {% include "../botoesrodape.html" %}
    </form>

    <div id="loading-message">
        <img src="{% static 'media/loading-gif-transparent-10.gif' %}"  style="width: 60px; height: 60px;">
        <p>Aguarde!!! Relatório sendo gerado...</p>
    </div>

    <script>
        document.getElementById("relatorioForm").onsubmit = function(e) {
            e.preventDefault();  // Evita o comportamento padrão de envio de formulário

            // Mostra a mensagem de "Aguarde"
            document.getElementById("loading-message").style.display = "block";

            // Faz o envio do formulário via AJAX
            var formData = new FormData(this);

            fetch("{% url 'liberacaovalores-tela' %}", {  // Altere para a URL correta
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            }).then(response => response.blob())
              .then(blob => {
                  // Cria um link temporário para baixar o PDF gerado
                  var link = document.createElement('a');
                  link.href = window.URL.createObjectURL(blob);
                  link.download = "relatorio.pdf";
                  link.click();

                  // Oculta a mensagem de "Aguarde" após o download
                  document.getElementById("loading-message").style.display = "none";
              })
              .catch(error => {
                  console.error('Erro ao gerar relatório:', error);
                  document.getElementById("loading-message").style.display = "none";
              });
        };
    </script>

{% endblock %}