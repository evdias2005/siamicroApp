{% extends "base.html" %}

{% load widget_tweaks %}


{% block title %} Movimentações do Processo {% endblock title %}


{% block content %}

    <div style="color:#4682B4; font-style: bold; font-size: 1.5rem; border-bottom: 1px solid white;">
        Movimentações do Processo
    </div>
    <div class="row" style="color: black; font-style: bold; font-size: 1rem;">
        <div class="col-md-10">Processo {{ numprocesso }} ( {{ localizacao }} ) | {{ clienteprocesso }} | Status: {{ statusprocesso }}
        </div>
        <div class="col-md-2">
            {% if perms.processos.add_movimentacao %}
                <div style="float:right;"> <a class="btn ghost-blue"
                                              href="{% url 'new-processomovimentacao' idprocesso %}"><i class="fa fa-plus-square fa-fw fa-1x"></i>
                    <small>Movimentação</small></a>
                </div>
            {% endif %}
        </div>
    </div>
    <hr>

<!--    <div style="border-bottom: 1px solid white;"></div>-->
    <table class="table table-striped table-bordered" style="width:100%" id="tabela-listar">

        <thead class="thead-dark align-middle">
            <tr>
                <th width="4%"><small><b>Id</b></small></th>
                <th width="1%"><small><b> </b></small></th>
                <th width="10%"><small><b>Data Movto</b></small></th>
                <th width="20%"><small><b>Local Origem</b></small></th>
                <th width="20%"><small><b>Local Destino</b></small></th>
                <th width="31%"><small><b>Observação</b></small></th>
                <th width="14%"><small><b>Ação</b></small></th>
            </tr>
        </thead>

        <tbody>
            {% for i in object_list %}
                <tr>
                    <td class="align-middle"><small> {{ i.id }} </small></td>
                    <td class="align-middle"> {% if i.is_recebido %}
                        <small><i class="fa fa-check fa-1x" style="color:green"></i></small> {% else %}  {% endif %}
                    </td>
                    <td class="align-middle"><small>{{ i.dtmovimento|date:"SHORT_DATE_FORMAT" }}</small></td>
                    <td class="align-middle"><small>{{ i.origem.nome }}</small></td>
                    <td class="align-middle"><small>{{ i.destino.nome }}</small></td>
                    <td class="align-middle"><small>{{ i.observacao }}</small></td>
                    <td class="align-middle">
                        {% if perms.processos.change_movimentacao %}
<!--                            <a href="{% url 'check-processomovimentacao' i.pk %}">-->
<!--                                <i class="fa fa-check-square-o fa-2x" style="color:green"></i> </a>-->
                                <button type="button" class="btn ghost-green" data-toggle="modal" data-target="#myModal0"
                                        data-id="{{ i.pk }}"><i class="fa fa-check-square-o fa-2x" style="color:green"></i>
                                </button>
                        {% endif %}
                        {% if perms.processos.delete_movimentacao %}
<!--                            <a href="{% url 'delete-processomovimentacao' i.pk %}">-->
<!--                                <i class="fa fa-trash-o fa-2x" style="color:red"></i> </a>-->
                                <button type="button" class="btn ghost-red" data-toggle="modal" data-target="#myModal1"
                                    data-id="{{ i.pk }}"><i class="fa fa-trash-o fa-2x" style="color:red"></i>
                                </button>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
<!--                <div style="color: #4682B4; font-style: bold; font-size: 1.5rem; text-align: center;">Não foram encontrados registros !!!</div>-->
            {% endfor %}
        </tbody>
    </table>

        <!-- Button trigger modal -->
        <!-- Modal0 -->
            <div class="modal fade" id="myModal0" tabindex="-1" role="dialog" aria-labelledby="myModalLabel0">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="myModalLabel0">Checa a Movimentação</h5>
                        </div>
                        <form id="ChecaMovimentacaoForm" method="post" action="{% url 'checar_movimentacao' 0 %}">
                            <div class="modal-body">
                                {% csrf_token %}
                                <p><b>Tem certeza que deseja checar a movimentação?</b></p>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary"><small>Sim</small></button>
                                <button type="button" class="btn btn-default" data-dismiss="modal"><small>Não</small></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        <!-- Modal1 -->
            <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="myModalLabel1">Apaga a Movimentação</h5>
                        </div>
                        <form id="ApagaMovimentacaoForm" method="post" action="{% url 'apagar_movimentacao' 0 %}">
                            <div class="modal-body">
                                {% csrf_token %}
                                <p><b>Tem certeza que deseja apagar a movimentação?</b></p>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary"><small>Sim</small></button>
                                <button type="button" class="btn btn-default" data-dismiss="modal"><small>Não</small></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

{% block scripts %}
<script>
    $(document).ready(function(){
        $("#tabela-listar").DataTable({
            scrollX: true,
            responsive: true,
            pageLength: 10,
            "language": {
                "search": "Procurar:",
                "infoEmpty": "Mostrando de 0 até 0 de 0 registros",
                "infoFiltered": " (filtrado de _MAX_ registros no total)",
                "lengthMenu": "Mostrar _MENU_ registros",
                "paginate": {
                    "first": "<<",
                    "last": ">>",
                    "next": ">",
                    "previous": "<"
                },
                "zeroRecords": "Não foram encontrados registros!!!",
                "info": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
            order: [[0, 'desc']],
            }
        });
    });
</script>

<script>
    $('#myModal0').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Botão que abriu o modal
        var id = String(button.data('id')).replace('.', ''); // Extrai o info do atributo data-id retirando o ponto do variável
        var form = $(this).find('form');
        var action = form.attr('action');

        form.attr('action', action.replace('0', id)); // Substitui o 0 pelo id real
    });

    $('#myModal1').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Botão que abriu o modal
        var id = String(button.data('id')).replace('.', ''); // Extrai o info do atributo data-id retirando o ponto da variável
        var form = $(this).find('form');
        var action = form.attr('action');

        form.attr('action', action.replace('0', id)); // Substitui o 0 pelo id real
    });
</script>

{% endblock %}

{% endblock content %}


<!--Solução: Modal genérico (preferido se tiver muitos registros)-->
<!--Se você tem MUITOS registros e não quer criar mil modais no HTML, então você faz um único modal, e passa o id dinamicamente via JavaScript.-->

<!--O esquema seria:-->

<!--No botão de deletar, você grava o pk em um data-id:-->

<!--<button type="button" class="btn ghost-red" data-toggle="modal" data-target="#myModal1" data-id="{{ i.pk }}">Apaga</button>-->
<!--No JavaScript, captura o data-id e atualiza o form do modal:-->

<!--<script>-->
<!--    $('#myModal1').on('show.bs.modal', function (event) {-->
<!--        var button = $(event.relatedTarget); // Botão que abriu o modal-->
<!--        var id = button.data('id'); // Extrai o info do atributo data-id-->
<!--        var form = $(this).find('form');-->
<!--        var action = form.attr('action');-->

<!--        form.attr('action', action.replace('0', id)); // Substitui o 0 pelo id real-->
<!--    });-->
<!--</script>-->

<!--No HTML do seu form do modal, deixa o action temporariamente com 0:-->

<!--<form id="ApagaMovimentacaoForm" method="post" action="{% url 'apagar_movimentacao' 0 %}">-->
<!--Esse 0 será substituído no momento que abrir o modal.-->